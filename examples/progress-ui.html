<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Bulk Upload with Real-time Progress</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          sans-serif;
        padding: 20px;
        background: #f5f5f5;
      }

      .container {
        max-width: 800px;
        margin: 0 auto;
        background: white;
        padding: 30px;
        border-radius: 10px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      }

      h2 {
        margin-bottom: 20px;
        color: #333;
      }

      input[type="file"] {
        padding: 10px;
        border: 2px dashed #ddd;
        border-radius: 5px;
        width: 100%;
        cursor: pointer;
        margin-bottom: 15px;
      }

      button {
        padding: 12px 24px;
        background: #007bff;
        color: white;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        font-size: 16px;
        font-weight: 500;
      }

      button:hover {
        background: #0056b3;
      }

      button:disabled {
        background: #ccc;
        cursor: not-allowed;
      }

      .status {
        margin: 20px 0;
        padding: 15px;
        background: #f8f9fa;
        border-radius: 5px;
        border-left: 4px solid #007bff;
      }

      .progress-section {
        margin-top: 20px;
      }

      .progress-bar {
        width: 100%;
        height: 40px;
        background: #e0e0e0;
        border-radius: 5px;
        overflow: hidden;
        margin: 10px 0;
      }

      .progress-fill {
        height: 100%;
        background: linear-gradient(90deg, #007bff, #0056b3);
        transition: width 0.3s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-weight: bold;
      }

      .files-list {
        margin-top: 20px;
      }

      .file-item {
        padding: 12px;
        border: 1px solid #ddd;
        border-radius: 5px;
        margin-bottom: 10px;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .file-item.pending {
        background: #fff3cd;
        border-color: #ffc107;
      }
      .file-item.uploading {
        background: #cfe2ff;
        border-color: #0d6efd;
      }
      .file-item.saving {
        background: #cfe2ff;
        border-color: #0d6efd;
      }
      .file-item.analyzing {
        background: #d1ecf1;
        border-color: #0dcaf0;
      }
      .file-item.completed {
        background: #d4edda;
        border-color: #28a745;
      }
      .file-item.failed {
        background: #f8d7da;
        border-color: #dc3545;
      }

      .file-name {
        font-weight: 500;
      }

      .file-status {
        padding: 4px 12px;
        border-radius: 12px;
        font-size: 14px;
        font-weight: 500;
      }

      .results-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
        gap: 20px;
        margin-top: 20px;
      }

      .result-card {
        border: 1px solid #ddd;
        border-radius: 8px;
        overflow: hidden;
      }

      .result-card img {
        width: 100%;
        height: 200px;
        object-fit: cover;
      }

      .result-content {
        padding: 12px;
      }

      .result-filename {
        font-weight: bold;
        margin-bottom: 8px;
        font-size: 14px;
      }

      .result-description {
        font-size: 13px;
        color: #666;
        margin-bottom: 8px;
      }

      .tags {
        display: flex;
        flex-wrap: wrap;
        gap: 4px;
      }

      .tag {
        padding: 4px 8px;
        background: #e7f3ff;
        color: #004085;
        border-radius: 12px;
        font-size: 12px;
      }

      .hidden {
        display: none;
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }

      .spinner {
        border: 3px solid #f3f3f3;
        border-top: 3px solid #007bff;
        border-radius: 50%;
        width: 20px;
        height: 20px;
        animation: spin 1s linear infinite;
        display: inline-block;
        margin-right: 10px;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h2>üì∏ Bulk Upload with Real-time Progress</h2>

      <input type="file" id="fileInput" accept="image/*" multiple />
      <div id="fileCount" style="margin-bottom: 15px; color: #666">
        No files selected
      </div>

      <button id="uploadBtn" disabled>Upload Images</button>

      <div id="status" class="status hidden"></div>

      <div id="progressSection" class="progress-section hidden">
        <h3>Progress: <span id="progressText">0%</span></h3>
        <div class="progress-bar">
          <div class="progress-fill" id="progressFill" style="width: 0%"></div>
        </div>
        <div style="margin-top: 10px; color: #666">
          <span id="completedCount">0</span> /
          <span id="totalCount">0</span> files completed
        </div>
      </div>

      <div id="filesList" class="files-list"></div>

      <div id="results" class="hidden">
        <h3 id="resultsTitle" style="margin-top: 30px"></h3>
        <div id="resultsGrid" class="results-grid"></div>
      </div>
    </div>

    <script>
      const fileInput = document.getElementById("fileInput");
      const fileCount = document.getElementById("fileCount");
      const uploadBtn = document.getElementById("uploadBtn");
      const status = document.getElementById("status");
      const progressSection = document.getElementById("progressSection");
      const progressText = document.getElementById("progressText");
      const progressFill = document.getElementById("progressFill");
      const completedCount = document.getElementById("completedCount");
      const totalCount = document.getElementById("totalCount");
      const filesList = document.getElementById("filesList");
      const results = document.getElementById("results");
      const resultsTitle = document.getElementById("resultsTitle");
      const resultsGrid = document.getElementById("resultsGrid");

      let selectedFiles = [];
      let eventSource = null;

      fileInput.addEventListener("change", (e) => {
        selectedFiles = Array.from(e.target.files);

        if (selectedFiles.length > 10) {
          alert("Maximum 10 images allowed");
          selectedFiles = selectedFiles.slice(0, 10);
        }

        fileCount.textContent = `${selectedFiles.length} file(s) selected (max 10)`;
        uploadBtn.disabled = selectedFiles.length === 0;
      });

      uploadBtn.addEventListener("click", async () => {
        if (selectedFiles.length === 0) return;

        uploadBtn.disabled = true;
        status.classList.remove("hidden");
        status.innerHTML = '<div class="spinner"></div>Starting upload...';

        const token = localStorage.getItem("accessToken");

        if (!token) {
          alert("Please login first");
          uploadBtn.disabled = false;
          return;
        }

        try {
          // Step 1: Start upload
          const formData = new FormData();
          selectedFiles.forEach((file) => {
            formData.append("images", file);
          });

          const response = await fetch("/api/upload/bulk-upload-and-analyze", {
            method: "POST",
            headers: {
              Authorization: `Bearer ${token}`,
            },
            body: formData,
          });

          if (!response.ok) {
            throw new Error("Upload failed to start");
          }

          const data = await response.json();
          const { uploadId, totalFiles } = data.data;

          status.innerHTML = `<div class="spinner"></div>Connected to upload session (ID: ${uploadId})`;
          progressSection.classList.remove("hidden");
          totalCount.textContent = totalFiles;

          // Step 2: Connect to SSE for progress
          eventSource = new EventSource(`/api/upload/progress/${uploadId}`);

          eventSource.onopen = () => {
            console.log("üì° Connected to progress stream");
            status.innerHTML =
              '<div class="spinner"></div>Processing images...';
          };

          eventSource.onmessage = (event) => {
            const message = JSON.parse(event.data);

            switch (message.type) {
              case "connected":
                console.log("Initial state:", message.data);
                updateProgress(message.data);
                break;

              case "progress":
                console.log("Progress:", message.data);
                updateProgress(message.data);
                break;

              case "complete":
                console.log("Complete:", message.data);
                updateProgress(message.data);
                displayResults(message.data);
                eventSource.close();
                status.classList.add("hidden");
                uploadBtn.disabled = false;
                break;
            }
          };

          eventSource.onerror = (error) => {
            console.error("SSE Error:", error);
            status.textContent =
              "Connection error. Upload may still be processing...";
            eventSource.close();
          };
        } catch (error) {
          console.error("Upload error:", error);
          alert(`Upload failed: ${error.message}`);
          status.classList.add("hidden");
          uploadBtn.disabled = false;
        }
      });

      function updateProgress(data) {
        const { completed, total, percentage, files } = data;

        progressText.textContent = `${percentage}%`;
        progressFill.style.width = `${percentage}%`;
        progressFill.textContent = `${percentage}%`;
        completedCount.textContent = completed;

        // Update files list
        filesList.innerHTML = "";
        files.forEach((file) => {
          const item = document.createElement("div");
          item.className = `file-item ${file.status}`;

          let statusText = file.status;
          let statusEmoji = "";

          switch (file.status) {
            case "pending":
              statusEmoji = "‚è≥";
              break;
            case "uploading":
              statusEmoji = "üì§";
              break;
            case "saving":
              statusEmoji = "üíæ";
              break;
            case "analyzing":
              statusEmoji = "ü§ñ";
              break;
            case "completed":
              statusEmoji = "‚úÖ";
              break;
            case "failed":
              statusEmoji = "‚ùå";
              break;
          }

          item.innerHTML = `
          <div>
            <div class="file-name">${file.filename}</div>
            ${
              file.error
                ? `<div style="color: #721c24; font-size: 13px;">${file.error}</div>`
                : ""
            }
          </div>
          <div class="file-status">${statusEmoji} ${statusText}</div>
        `;

          filesList.appendChild(item);
        });
      }

      function displayResults(data) {
        const { results, errors, duration } = data;

        results.classList.remove("hidden");
        resultsTitle.textContent = `‚úÖ Completed ${data.completed} files in ${duration}s`;

        resultsGrid.innerHTML = "";

        results.forEach((result) => {
          const card = document.createElement("div");
          card.className = "result-card";

          const tags = result.tags
            ? result.tags
                .map((tag) => `<span class="tag">${tag}</span>`)
                .join("")
            : "";

          card.innerHTML = `
          <img src="${result.publicUrl}" alt="${result.filename}">
          <div class="result-content">
            <div class="result-filename">${result.filename}</div>
            <div class="result-description">${
              result.description || "No description"
            }</div>
            <div class="tags">${tags}</div>
          </div>
        `;

          resultsGrid.appendChild(card);
        });
      }
    </script>
  </body>
</html>
